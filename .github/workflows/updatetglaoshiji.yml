name: Update TG Laoshiji (Mirror)

on:
  schedule:
    # 北京时间：08:00, 12:00, 16:00, 20:00
    - cron: "0 0,4,8,12 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check Status
        id: check_status
        run: |
          # 统一使用 TZ='Asia/Shanghai' 确保日期对齐北京时间
          BEIJING_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          LAST_COMMIT=$(git log -1 --format=%s || echo "none")
          
          echo "Current Beijing Date: $BEIJING_DATE"
          echo "Last Commit Message: $LAST_COMMIT"
          
          if [[ "$LAST_COMMIT" == *"tglaoshiji-$BEIJING_DATE"* ]] && [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "should_update=false" >> $GITHUB_ENV
          else
            echo "should_update=true" >> $GITHUB_ENV
          fi

      - name: Download and Strategy Check
        if: env.should_update == 'true'
        run: |
          # 1. 变量定义（强制指定时区）
          YEAR=$(TZ='Asia/Shanghai' date +'%Y')
          MONTH=$(TZ='Asia/Shanghai' date +'%m' | sed 's/^0//')
          DAY_TODAY=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          
          Y_YEAR=$(TZ='Asia/Shanghai' date -d "24 hours ago" +'%Y')
          Y_MONTH=$(TZ='Asia/Shanghai' date -d "24 hours ago" +'%m' | sed 's/^0//')
          Y_DAY=$(TZ='Asia/Shanghai' date -d "24 hours ago" +'%Y%m%d')

          # 2. 尝试抓取今天的
          URL_TODAY="https://sfdr.zaixianyouxi.dpdns.org/uploads/${YEAR}/${MONTH}/${DAY_TODAY}.yaml"
          echo "Debug: Today URL is $URL_TODAY"
          
          # -f 选项会让 curl 在 404 时返回非零退出码，-L 跟踪重定向
          if curl -sL -f "$URL_TODAY" -o today.yml; then
            if [ $(wc -c < today.yml) -gt 1024 ]; then
              echo "Success: Today's source obtained."
              mv today.yml tglaoshiji.yml
            else
              echo "Error: File too small, might be invalid content."
              rm -f today.yml
              SUCCESS=false
            fi
          else
            echo "Today's source NOT ready (404 or Network Error)."
            SUCCESS=false
          fi

          # 3. 如果今天没成功，进入策略判断
          if [ ! -f tglaoshiji.yml ]; then
            if [ "$SUCCESS" != "true" ]; then
              echo "Local file missing. Attempting Yesterday's source..."
              URL_YESTERDAY="https://sfdr.zaixianyouxi.dpdns.org/uploads/${Y_YEAR}/${Y_MONTH}/${Y_DAY}.yaml"
              echo "Debug: Yesterday URL is $URL_YESTERDAY"
              
              if curl -sL -f "$URL_YESTERDAY" -o tglaoshiji.yml; then
                echo "Success: Yesterday's source obtained as fallback."
              else
                echo "Error: Even yesterday's file is missing."
                exit 1
              fi
            fi
          elif [ -f today.yml ]; then
             # 这条路径通常不会执行，仅作为逻辑完备
             mv today.yml tglaoshiji.yml
          else
             # 如果今天抓不到，本地又有文件，就跳过提交
             if [ ! -s today.yml ]; then
                echo "Keeping local version. Skipping commit."
                echo "skip_commit=true" >> $GITHUB_ENV
             fi
          fi

      - name: Commit and push
        if: env.should_update == 'true' && env.skip_commit != 'true'
        run: |
          # 再次确保 DATE_STR 正确
          DATE_STR=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add tglaoshiji.yml
          
          if git diff --staged --quiet; then
            echo "No changes detected in file content."
          else
            git commit -m "Update tglaoshiji-$DATE_STR"
            git push
          fi
