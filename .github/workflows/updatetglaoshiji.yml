name: Update TG Laoshiji (Mirror)

on:
  schedule:
    # 修改分钟为 21，避开 GitHub 调度高峰
    # 北京时间：08:21, 12:21, 16:21, 20:21
    - cron: "21 0,4,8,12 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check Status
        id: check_status
        run: |
          BEIJING_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          LAST_COMMIT=$(git log -1 --format=%s || echo "none")
          
          echo "Current Date: $BEIJING_DATE"
          echo "Last Commit: $LAST_COMMIT"

          # 如果最后一次提交信息包含今天的日期，且不是手动触发，则跳过
          if [[ "$LAST_COMMIT" == *"tglaoshiji-$BEIJING_DATE"* ]] && [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "Already updated today. Skipping..."
            echo "should_update=false" >> $GITHUB_ENV
          else
            echo "should_update=true" >> $GITHUB_ENV
          fi

      - name: Download and Strategy Check
        if: env.should_update == 'true'
        run: |
          # 1. 变量准备（北京时间）
          YEAR=$(TZ='Asia/Shanghai' date +'%Y')
          MONTH=$(TZ='Asia/Shanghai' date +'%m' | sed 's/^0//')
          DAY_TODAY=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          
          Y_YEAR=$(TZ='Asia/Shanghai' date -d "24 hours ago" +'%Y')
          Y_MONTH=$(TZ='Asia/Shanghai' date -d "24 hours ago" +'%m' | sed 's/^0//')
          Y_DAY=$(TZ='Asia/Shanghai' date -d "24 hours ago" +'%Y%m%d')

          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          
          # 2. 尝试下载今天
          URL_TODAY="https://sfdr.zaixianyouxi.dpdns.org/uploads/${YEAR}/${MONTH}/${DAY_TODAY}.yaml"
          echo "Trying Today: $URL_TODAY"
          
          # 使用 -f 确保 404 时报错退出，不保存文件
          if curl -sL -f -A "$UA" --retry 3 --connect-timeout 15 "$URL_TODAY" -o temp.yml && [ $(stat -c%s temp.yml) -gt 2048 ]; then
            mv temp.yml tglaoshiji.yml
            echo "status=success" >> $GITHUB_ENV
            echo "Today's file downloaded."
          else
            echo "Today's source NOT ready yet."
            
            # 3. 核心逻辑判断
            if [ -f tglaoshiji.yml ]; then
              echo "Existing local file is enough for now. Waiting for next cron."
              echo "status=skip_commit" >> $GITHUB_ENV
              rm -f temp.yml || true
            else
              echo "No local file! Fetching Yesterday's fallback..."
              URL_YESTERDAY="https://sfdr.zaixianyouxi.dpdns.org/uploads/${Y_YEAR}/${Y_MONTH}/${Y_DAY}.yaml"
              if curl -sL -f -A "$UA" --retry 3 --connect-timeout 15 "$URL_YESTERDAY" -o tglaoshiji.yml && [ $(stat -c%s tglaoshiji.yml) -gt 2048 ]; then
                echo "status=success" >> $GITHUB_ENV
                echo "Yesterday's file downloaded as fallback."
              else
                echo "Error: Both sources fail and no local backup."
                exit 1
              fi
            fi
          fi

      - name: Commit and push
        if: env.should_update == 'true' && env.status == 'success'
        run: |
          DATE_STR=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add tglaoshiji.yml
          
          if git diff --staged --quiet; then
            echo "Content is identical to current repo version. No update needed."
          else
            git commit -m "Update tglaoshiji-$DATE_STR"
            git push
          fi
