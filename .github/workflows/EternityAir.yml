name: EternityAir Auto Update & Clean

on:
  schedule:
    - cron: "0 * * * *"   # 每 60 分钟执行一次
  workflow_dispatch:       # 手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download source file
        run: |
          URL="https://github.com/mahdibland/V2RayAggregator/raw/refs/heads/master/EternityAir.yml"
          echo "Downloading: $URL"

          if curl -fSL "$URL" -o source.yml; then
            echo "download_success=true" >> $GITHUB_ENV
          else
            echo "download_success=false" >> $GITHUB_ENV
          fi

      - name: Exit if download failed
        if: env.download_success == 'false'
        run: |
          echo "Source file not available. Exiting."
          exit 0

      - name: Clean nodes (remove null / missing type / invalid)
        run: |
          echo "Cleaning nodes..."

          # 提取 proxies 部分
          awk '
            BEGIN { in_proxies=0 }
            /^proxies:/ { in_proxies=1; print; next }
            /^[a-zA-Z]/ && in_proxies==1 { in_proxies=0 }
            {
              if (in_proxies==1) {
                if ($0 ~ /null/) next
                if ($0 ~ /type:/) valid=1
                if ($0 ~ /^- name:/) valid=0
                if (valid==0 && $0 ~ /server:/) next
              }
              print
            }
          ' source.yml > cleaned.yml

      - name: Replace original with cleaned version
        run: |
          mv cleaned.yml EternityAir.yml

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add EternityAir.yml
          git commit -m "Auto update & clean EternityAir.yml" || exit 0
          git push
