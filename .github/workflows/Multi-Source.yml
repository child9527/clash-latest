name: Multi-Source Auto Update & Clean (Optimized)

on:
  schedule:
    - cron: "0 * * * *"   # 每 60 分钟执行一次
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install yq (fast)
        run: |
          sudo snap install yq

      - name: Download all sources
        run: |
          declare -A sources=(
            ["snakem982_1"]="https://github.com/snakem982/proxypool/raw/refs/heads/main/source/clash-meta.yaml"
            ["snakem982_2"]="https://github.com/snakem982/proxypool/raw/refs/heads/main/source/clash-meta-2.yaml"
            ["free18"]="https://github.com/free18/v2ray/raw/refs/heads/main/c.yaml"
            ["free-nodes"]="https://github.com/child9527/clash-latest/raw/refs/heads/main/free-nodes.yml"
            ["tglaoshiji"]="https://github.com/child9527/clash-latest/raw/refs/heads/main/tglaoshiji.yml"
            ["Eternity"]="https://github.com/mahdibland/V2RayAggregator/raw/refs/heads/master/Eternity.yml"
          )

          mkdir -p sources

          for name in "${!sources[@]}"; do
            url="${sources[$name]}"
            echo "Downloading $name from $url"
            curl -fsSL "$url" -o "sources/$name.yml" || true
          done

      - name: Merge + Clean + Dedupe (optimized)
        run: |
          echo "[]" > merged.yml

          # 合并所有 proxies
          for file in sources/*.yml; do
            yq '.proxies // []' "$file" >> merged.yml || true
          done

          # 一次性完成：清洗 + 去重
          yq -s '
            add
            | map(select(. != null))
            | map(select(.type != null))
            | map(select(.server != null))
            | map(select(.port != null))
            | unique_by(.server + ":" + (.port|tostring) + ":" + .type)
          ' merged.yml > proxies_tmp.yml

          # 修复重复 name
          awk '
            BEGIN { FS=": "; OFS=": " }
            /^- name:/ {
              name=$2
              count[name]++
              if (count[name] > 1) $2 = name "-" count[name]
            }
            { print }
          ' proxies_tmp.yml > proxies_final.yml

      - name: Build final Clash file (all.yml)
        run: |
          cat > all.yml <<EOF
port: 7890
socks-port: 7891
allow-lan: false
mode: rule
log-level: info
external-controller: 127.0.0.1:9090
proxies:
EOF

          cat proxies_final.yml >> all.yml

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add all.yml
          git commit -m "Optimized auto update & clean (6 sources) → all.yml" || exit 0
          git push
