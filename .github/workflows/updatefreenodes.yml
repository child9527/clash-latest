name: Update Free Nodes (Mirror)

on:
  schedule:
    # 北京时间：08:17, 12:17, 16:17, 20:17
    - cron: "17 0,4,8,12 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check Status
        id: check_status
        run: |
          BEIJING_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          LAST_COMMIT_MSG=$(git log -1 --format=%s || echo "Initial commit")
          
          echo "Current Date: $BEIJING_DATE"
          echo "Last Commit: $LAST_COMMIT_MSG"
          
          # 只有当最后一次提交确实包含了今天的日期，才跳过
          if [[ "$LAST_COMMIT_MSG" == *"$BEIJING_DATE"* ]] && [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "Today's data already updated. Skipping..."
            echo "should_update=false" >> $GITHUB_ENV
          else
            echo "Update needed."
            echo "should_update=true" >> $GITHUB_ENV
          fi

      - name: Download and Sync
        if: env.should_update == 'true'
        run: |
          # 尝试获取最近 3 天的文件，使用你提供的正确 master 分支路径
          FOUND=false
          for i in {0..2}; do
            TARGET_DATE=$(TZ='Asia/Shanghai' date -d "$i days ago" +'%Y%m%d')
            # 修正后的正确路径：refs/heads/master
            URL="https://raw.githubusercontent.com/free-nodes/clashfree/refs/heads/master/clash${TARGET_DATE}.yml"
            echo "Trying to fetch: $URL"
            
            if curl -sLf "$URL" -o temp.yml && [ -s temp.yml ]; then
              echo "Success: Found file for $TARGET_DATE"
              mv temp.yml free-nodes.yml
              echo "final_msg=Update freenodes-$TARGET_DATE" >> $GITHUB_ENV
              FOUND=true
              break
            fi
          done

          if [ "$FOUND" = false ]; then
            echo "Critical: Could not find any source files in the last 3 days at master branch."
            if [ -f free-nodes.yml ]; then
              echo "Local file exists, keeping current version."
              echo "skip_commit=true" >> $GITHUB_ENV
            else
              echo "No local file and no remote file. Exit without error."
              exit 0
            fi
          fi

      - name: Commit and push
        if: env.should_update == 'true' && env.skip_commit != 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add free-nodes.yml
          
          if git diff --staged --quiet; then
            echo "No changes in file content. Skipping push."
          else
            git commit -m "${{ env.final_msg }}"
            git push
          fi
