name: Update Free Nodes (Mirror)

on:
  schedule:
    # 修改为更冷门的时间点，避开 0, 10, 30 分的高峰
    # 北京时间：08:17, 12:17, 16:17, 20:17
    - cron: "17 0,4,8,12 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check Status
        id: check_status
        run: |
          BEIJING_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          LAST_COMMIT_MSG=$(git log -1 --format=%s || echo "Initial commit")
          
          echo "Current Date: $BEIJING_DATE"
          echo "Last Commit: $LAST_COMMIT_MSG"
          
          # 只有当最后一次提交确实包含了今天的日期，才跳过
          if [[ "$LAST_COMMIT_MSG" == *"$BEIJING_DATE"* ]] && [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "Today's data already updated. Skipping..."
            echo "should_update=false" >> $GITHUB_ENV
          else
            echo "Update needed."
            echo "should_update=true" >> $GITHUB_ENV
          fi

      - name: Download and Sync
        if: env.should_update == 'true'
        run: |
          DATE_STR=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          YESTERDAY=$(TZ='Asia/Shanghai' date -d "yesterday" +'%Y%m%d')
          
          # 1. 尝试下载
          URL_TODAY="https://raw.githubusercontent.com/free-nodes/clashfree/main/clash${DATE_STR}.yml"
          echo "Target URL: $URL_TODAY"
          
          # 使用 --fail 确保 404 时返回非零状态码
          if curl -sLf "$URL_TODAY" -o today.yml && [ -s today.yml ]; then
            echo "Success: Fetched today's file."
            mv today.yml free-nodes.yml
            echo "final_msg=Update freenodes-$DATE_STR" >> $GITHUB_ENV
          else
            echo "Today's source is not ready (404 or empty)."
            
            # 2. 如果仓库里还没有文件，或者文件太旧，尝试拿昨天的
            if [ ! -f free-nodes.yml ] || [[ ! $(git log -1 --format=%s) == *"$YESTERDAY"* ]]; then
              echo "Local file is missing or outdated. Fetching yesterday's fallback..."
              URL_YESTERDAY="https://raw.githubusercontent.com/free-nodes/clashfree/main/clash${YESTERDAY}.yml"
              if curl -sLf "$URL_YESTERDAY" -o free-nodes.yml; then
                echo "final_msg=Update freenodes-$YESTERDAY (Fallback)" >> $GITHUB_ENV
              else
                echo "Critical: Yesterday's source also fails."
                exit 1
              fi
            else
              echo "Local file is already from yesterday. No action needed, wait for next cron."
              echo "skip_commit=true" >> $GITHUB_ENV
            fi
          fi

      - name: Commit and push
        if: env.should_update == 'true' && env.skip_commit != 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add free-nodes.yml
          
          if git diff --staged --quiet; then
            echo "No changes in file content. Skipping push."
          else
            git commit -m "${{ env.final_msg }}"
            git push
          fi
