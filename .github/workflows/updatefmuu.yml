name: ğŸ§¼ æ¸…æ´— mfuu æ··ä¹±è®¢é˜…

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  clean-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ å®‰è£… Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install requests PyYAML

      - name: ğŸ› ï¸ è¿è¡Œæ¸…æ´—ç¨‹åº
        run: |
          python -c "
          import requests
          import yaml
          import re
          import os
          import sys

          def clean_mfuu():
              url = 'https://github.com/mfuu/v2ray/raw/refs/heads/master/clash.yaml'
              headers = {'User-Agent': 'ClashMeta'}
              try:
                  print('æ­£åœ¨ä¸‹è½½ mfuu æºå¹¶è¿›è¡Œæ·±åº¦ç±»å‹ä¿®å¤...')
                  r = requests.get(url, headers=headers, timeout=30)
                  r.raise_for_status()
                  text = r.text
                  
                  # é»˜è®¤è¿›å…¥æ­£åˆ™æ¨¡å¼ï¼Œå› ä¸ºå®ƒæœ€ç¨³
                  data = {'proxies': []}
                  # æå–æ¯ä¸€ä¸ªä»£ç†å— {}
                  proxy_lines = re.findall(r'-\s*\{([^}]+)\}', text)
                  
                  for line in proxy_lines:
                      p = {}
                      # æå–æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„é”®å€¼å¯¹
                      for key in ['name', 'server', 'port', 'type', 'cipher', 'password', 'uuid', 'alterId', 'network', 'ws-path', 'tls', 'sni', 'udp', 'skip-cert-verify']:
                          match = re.search(fr'{key}:\s*([^,\"\s\}]+)', line)
                          if match:
                              val = match.group(1).strip().strip('\"').strip(\"'\")
                              
                              # ç±»å‹è½¬æ¢æ ¡å‡†
                              if key in ['tls', 'udp', 'skip-cert-verify']:
                                  p[key] = (val.lower() == 'true') # è½¬ä¸ºå¸ƒå°”å€¼
                              elif key == 'port' or key == 'alterId':
                                  try: p[key] = int(val) # è½¬ä¸ºæ•´æ•°
                                  except: p[key] = val
                              else:
                                  p[key] = val
                      if p: data['proxies'].append(p)

                  if not data['proxies']:
                      print('é”™è¯¯ï¼šæœªèƒ½æå–åˆ°ä»»ä½•èŠ‚ç‚¹')
                      return

                  clean_proxies = []
                  for p in data['proxies']:
                      # æ¸…æ´—èŠ‚ç‚¹åç§°ï¼Œé˜²æ­¢ Clash è§£æå‡ºé”™
                      name = str(p.get('name', 'Node'))
                      # è¿‡æ»¤æ‰è¡¨æƒ…ç¬¦å·å’Œå¼•å·ï¼Œåªä¿ç•™å­—æ¯æ•°å­—ä¸­æ–‡æ¨ªæ 
                      name = re.sub(r'[^\w\s\-\.\u4e00-\u9fa5]', '', name)
                      p['name'] = name.strip() or f'Node-{p.get(\"server\", \"\")}'
                      
                      # ä¿®æ­£åŠ å¯†åè®®å
                      if p.get('type') == 'ss':
                          method = p.get('cipher') or p.get('method')
                          if method == 'chacha20-poly1305':
                              p['cipher'] = 'chacha20-ietf-poly1305'
                      
                      clean_proxies.append(p)

                  # æ„é€ æ ‡å‡†è¾“å‡º
                  output = {
                      'proxies': clean_proxies,
                      'proxy-groups': [{'name': 'Proxy', 'type': 'select', 'proxies': [p['name'] for p in clean_proxies]}],
                      'rules': ['MATCH,Proxy']
                  }

                  with open('mfuu.yml', 'w', encoding='utf-8') as f:
                      # æ ¸å¿ƒï¼šå¿…é¡»ä½¿ç”¨ safe_dump ä¸” ensure_ascii=False
                      yaml.dump(output, f, allow_unicode=True, sort_keys=False, default_flow_style=False)
                  
                  print(f'âœ… ç±»å‹æ ¡å‡†æˆåŠŸï¼å…±è®¡ {len(clean_proxies)} ä¸ªèŠ‚ç‚¹å·²å­˜å…¥ mfuu.yml')
                  
              except Exception as e:
                  print(f'âŒ æ·±åº¦ä¿®å¤å¤±è´¥: {e}')
                  sys.exit(1)

          if __name__ == '__main__':
              clean_mfuu()
          "

      - name: ğŸ“¤ æ¨é€æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add mfuu.yml
          git commit -m "Fix mfuu data types (tls: bool, port: int)" || exit 0
          git push
