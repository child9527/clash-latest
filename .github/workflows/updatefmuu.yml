name: ğŸ§¼ æ¸…æ´— mfuu æ··ä¹±è®¢é˜…

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  clean-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ å®‰è£… Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install requests PyYAML

      - name: ğŸ› ï¸ è¿è¡Œæ¸…æ´—ç¨‹åº
        run: |
          python -c "
          import requests
          import yaml
          import re
          import os
          import sys

          def clean_mfuu():
              url = 'https://github.com/mfuu/v2ray/raw/refs/heads/master/clash.yaml'
              headers = {'User-Agent': 'ClashMeta'}
              try:
                  print('æ­£åœ¨ä¸‹è½½ mfuu æºå¹¶è¿›è¡Œç»ˆææš´åŠ›é¢„å¤„ç†...')
                  r = requests.get(url, headers=headers, timeout=30)
                  r.raise_for_status()
                  
                  text = r.text
                  
                  # --- é˜¶æ®µ 1ï¼šæ¨åœŸæœºå¼å­—ç¬¦ä¸²æ›¿æ¢ ---
                  # é’ˆå¯¹è§£æå™¨æŠ¥é”™çš„ ws-path é—®å·é—®é¢˜ï¼Œå¼ºè¡Œç»™æ‰€æœ‰ ws-path çš„å€¼åŠ ä¸Šå¼•å·
                  # å³ä½¿åŸæ¥æœ‰å¼•å·ä¹Ÿä¸æ€•ï¼Œæ›¿æ¢åå˜æˆåŒå¼•å·åŒ…è£¹
                  text = text.replace('ws-path: /', 'ws-path: \"/')
                  # åœ¨é€—å·æˆ–è€…å¤§æ‹¬å·å‰è¡¥ä¸Šç»“æŸå¼•å·
                  text = text.replace(', tls:', '\", tls:')
                  text = text.replace(', sni:', '\", sni:')
                  text = text.replace('}}', '\"}}')
                  
                  # é’ˆå¯¹ name é‡Œçš„ä¹±ç å’Œå¼•å·
                  # å¼ºåˆ¶æŠŠ name: åé¢ç›´åˆ°é€—å·å‰çš„éƒ¨åˆ†æ¸…ç†æ‰æ•æ„Ÿè¯ï¼Œå¹¶åŠ ä¸Šå¼•å·
                  # ç”¨æ­£åˆ™æ•è· name: åˆ°ç¬¬ä¸€ä¸ªé€—å·ä¹‹é—´çš„å†…å®¹
                  text = re.sub(r'name:\s*([^,]+),', r'name: \"\1\",', text)

                  print('é¢„å¤„ç†å®Œæˆï¼Œå°è¯•äºŒæ¬¡è§£æ...')
                  
                  # --- é˜¶æ®µ 2ï¼šå°è¯•åŠ è½½ ---
                  # å¦‚æœè¿˜æ˜¯æŠ¥é”™ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨æ­£åˆ™è¡¨è¾¾å¼å¼ºè¡Œæå–å…³é”®å­—æ®µ
                  try:
                      data = yaml.safe_load(text)
                  except Exception as e:
                      print(f'YAML è§£æä¾ç„¶å¤±è´¥ï¼Œå¯åŠ¨ç´§æ€¥æ­£åˆ™æå–æ¨¡å¼...')
                      # å¦‚æœ YAML è§£æå™¨å½»åº•æŒ‚äº†ï¼Œæˆ‘ä»¬æ‰‹å·¥æå– proxies åˆ—è¡¨
                      data = {'proxies': []}
                      proxy_lines = re.findall(r'-\s*\{([^}]+)\}', text)
                      for line in proxy_lines:
                          p = {}
                          # æå– name, server, port, type, cipher, password, uuid ç­‰å…³é”®é¡¹
                          for key in ['name', 'server', 'port', 'type', 'cipher', 'password', 'uuid', 'alterId', 'network', 'ws-path', 'tls']:
                              match = re.search(fr'{key}:\s*([^,\"]+)', line)
                              if match:
                                  p[key] = match.group(1).strip().strip('\"').strip(\"'\")
                          if p: data['proxies'].append(p)

                  if not data or 'proxies' not in data or not data['proxies']:
                      print('é”™è¯¯ï¼šæ— æ³•æå–æœ‰æ•ˆä»£ç†æ•°æ®')
                      return

                  # --- é˜¶æ®µ 3ï¼šæ ‡å‡†åŒ–è¾“å‡º ---
                  clean_proxies = []
                  for p in data['proxies']:
                      if not isinstance(p, dict): continue
                      
                      # æ¸…æ´—åç§°ï¼šåˆ æ‰æ‰€æœ‰å¥‡æ€ªçš„è¡¨æƒ…ã€å¼•å·å’Œç¬¦å·
                      name = str(p.get('name', 'Unknown'))
                      name = re.sub(r'[^\w\s\-\.\u4e00-\u9fa5]', '', name)
                      p['name'] = name.strip() or f'Node-{p.get(\"server\", \"\")}'
                      
                      # ä¿®æ­£åŠ å¯†
                      if p.get('type') == 'ss':
                          method = p.get('cipher') or p.get('method')
                          if method == 'chacha20-poly1305':
                              p['cipher'] = 'chacha20-ietf-poly1305'
                      
                      # ç¡®ä¿ç«¯å£æ˜¯æ•°å­—
                      if 'port' in p:
                          try: p['port'] = int(p['port'])
                          except: pass

                      clean_proxies.append(p)

                  output = {
                      'proxies': clean_proxies,
                      'proxy-groups': [{'name': 'Proxy', 'type': 'select', 'proxies': [p['name'] for p in clean_proxies]}],
                      'rules': ['MATCH,Proxy']
                  }

                  with open('mfuu.yml', 'w', encoding='utf-8') as f:
                      yaml.dump(output, f, allow_unicode=True, sort_keys=False, default_flow_style=False)
                  print(f'âœ… æš´åŠ›æ”¶å‰²æˆåŠŸï¼å…±è®¡ {len(clean_proxies)} ä¸ªèŠ‚ç‚¹ã€‚')
                  
              except Exception as e:
                  print(f'âŒ ç»ˆææ¸…æ´—å¤±è´¥: {e}')
                  sys.exit(1)

          if __name__ == '__main__':
              clean_mfuu()
          "

      - name: ğŸ“¤ æ¨é€æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add mfuu.yml
          git commit -m "Update mfuu.yml (Forced Sanitization)" || exit 0
          git push
