name: ğŸ§¼ æ¸…æ´— mfuu æ··ä¹±è®¢é˜…

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹è¿è¡Œ

jobs:
  clean-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ å®‰è£… Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ› ï¸ è¿è¡Œæ¸…æ´—ç¨‹åº
        run: |
          python -c '
          import requests
          import yaml
          import re
          import os

          def clean_mfuu():
              url = "https://github.com/mfuu/v2ray/raw/refs/heads/master/clash.yaml"
              headers = {"User-Agent": "ClashMeta"}
              try:
                  print(f"æ­£åœ¨ä¸‹è½½ mfuu æº...")
                  r = requests.get(url, headers=headers, timeout=30)
                  r.raise_for_status()
                  
                  # æ ¸å¿ƒä¿®å¤ 1ï¼šå¤„ç†åµŒå¥—åŒå¼•å·çš„é‡ç¾åŒº
                  # å°†ç±»ä¼¼ "FR-"2001:xxx"-061" ä¿®å¤ä¸º "FR-2001:xxx-061"
                  content = r.text
                  content = re.sub(r"\"([^\"]*)\"([^\"]*)\"([^\"]*)\"", r"\1\2\3", content)
                  
                  # æ ¸å¿ƒä¿®å¤ 2ï¼šåŠ è½½ YAML å¹¶è¿›ä¸€æ­¥æ¸…æ´—æ•°æ®ç»“æ„
                  data = yaml.safe_load(content)
                  if not data or "proxies" not in data:
                      print("æ•°æ®æ ¼å¼é”™è¯¯")
                      return

                  clean_proxies = []
                  for p in data["proxies"]:
                      if not isinstance(p, dict): continue
                      
                      # å½»åº•æ¸…æ´—èŠ‚ç‚¹åç§°ä¸­çš„æ‰€æœ‰å¼•å·å’Œç‰¹æ®Šç©ºæ ¼
                      raw_name = str(p.get("name", "Unknown"))
                      p["name"] = raw_name.replace("\"", "").replace("'" , "").strip()
                      
                      # ä¿®æ­£åŠ å¯†åè®®å (Verge å…¼å®¹æ€§)
                      if p.get("type") == "ss" and p.get("cipher") == "chacha20-poly1305":
                          p["cipher"] = "chacha20-ietf-poly1305"
                      
                      clean_proxies.append(p)

                  # æ„é€ æ ‡å‡†çš„è¾“å‡ºç»“æ„
                  output = {
                      "proxies": clean_proxies,
                      "proxy-groups": [
                          {
                              "name": "Proxy",
                              "type": "select",
                              "proxies": [p["name"] for p in clean_proxies]
                          }
                      ],
                      "rules": ["MATCH,Proxy"]
                  }

                  # å†™å…¥æ ¹ç›®å½•
                  with open("mfuu.yml", "w", encoding="utf-8") as f:
                      yaml.dump(output, f, allow_unicode=True, sort_keys=False, default_flow_style=False)
                  print(f"âœ… æˆåŠŸæ¸…æ´—å¹¶ä¿å­˜ {len(clean_proxies)} ä¸ªèŠ‚ç‚¹åˆ° mfuu.yml")
                  
              except Exception as e:
                  print(f"âŒ è¿è¡Œå‡ºé”™: {e}")
                  exit(1)

          if __name__ == "__main__":
              clean_mfuu()
          '

      - name: ğŸ“¤ æ¨é€æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add mfuu.yml
          git commit -m "Update mfuu.yml (Cleaned)" || exit 0
          git push
