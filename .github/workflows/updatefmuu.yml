name: ğŸ§¼ æ¸…æ´— mfuu æ··ä¹±è®¢é˜…

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  clean-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ å®‰è£… Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install requests PyYAML

      - name: ğŸ› ï¸ è¿è¡Œæ¸…æ´—ç¨‹åº
        run: |
          python -c "
          import requests
          import yaml
          import re
          import os
          import sys

          def clean_mfuu():
              url = 'https://github.com/mfuu/v2ray/raw/refs/heads/master/clash.yaml'
              headers = {'User-Agent': 'ClashMeta'}
              try:
                  print('æ­£åœ¨ä¸‹è½½ mfuu æºå¹¶è¿›è¡Œæš´åŠ›é¢„å¤„ç†...')
                  r = requests.get(url, headers=headers, timeout=30)
                  r.raise_for_status()
                  
                  text = r.text
                  
                  # --- æš´åŠ›æ–‡æœ¬ä¿®å¤é˜¶æ®µ ---
                  # 1. ä¿®å¤ ws-path ç¼ºå¤±å¼•å·å¯¼è‡´çš„è§£æé”™è¯¯ (é’ˆå¯¹å«æœ‰ ? çš„è·¯å¾„)
                  # å¯»æ‰¾ ws-path: /xxx?xxx æ›¿æ¢ä¸º ws-path: '/xxx?xxx'
                  text = re.sub(r'ws-path:\s*([^,\s\}\'\"]+\?[^,\s\}]*)', r\"ws-path: '\1'\", text)
                  
                  # 2. ä¿®å¤ name å­—æ®µåµŒå¥—åŒå¼•å·çš„é—®é¢˜ (å…ˆæŠŠæœ€å¤–å±‚çš„åŒå¼•å·è„±æ‰)
                  text = re.sub(r'name:\s*\"([^\"]*)\"', r'name: \1', text)
                  
                  # 3. å†æ¬¡æš´åŠ›æ¸…é™¤æ‰€æœ‰èŠ‚ç‚¹è¡Œé‡Œå¯èƒ½å¼•èµ·å†²çªçš„åŒå¼•å· (å› ä¸ºæˆ‘ä»¬è¦é‡å†™åå­—)
                  # è¿™ä¸€æ­¥æ˜¯ä¸ºäº†é˜²æ­¢ {name: \"xxx\"} è¿™ç§ç»“æ„
                  text = text.replace('\\\"', '')

                  print('é¢„å¤„ç†å®Œæˆï¼Œå°è¯•è§£æ YAML...')
                  data = yaml.safe_load(text)
                  
                  if not data or 'proxies' not in data:
                      print('é”™è¯¯ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆä»£ç†æ•°æ®')
                      return

                  clean_proxies = []
                  for p in data['proxies']:
                      if not isinstance(p, dict): continue
                      
                      # å½»åº•æ¸…æ´—èŠ‚ç‚¹åç§°
                      raw_name = str(p.get('name', 'Unknown'))
                      # åˆ æ‰æ‰€æœ‰æ®‹ç•™çš„å¼•å·ï¼Œé¿å… Verge æŠ¥é”™
                      for char in ['\"', \"'\"]:
                          raw_name = raw_name.replace(char, '')
                      p['name'] = raw_name.strip()
                      
                      # ä¿®æ­£ SS åè®®åŠ å¯†
                      if p.get('type') == 'ss':
                          method = p.get('cipher') or p.get('method')
                          if method == 'chacha20-poly1305':
                              p['cipher'] = 'chacha20-ietf-poly1305'
                      
                      clean_proxies.append(p)

                  output = {
                      'proxies': clean_proxies,
                      'proxy-groups': [
                          {
                              'name': 'Proxy',
                              'type': 'select',
                              'proxies': [p['name'] for p in clean_proxies]
                          }
                      ],
                      'rules': ['MATCH,Proxy']
                  }

                  with open('mfuu.yml', 'w', encoding='utf-8') as f:
                      yaml.dump(output, f, allow_unicode=True, sort_keys=False, default_flow_style=False)
                  print(f'âœ… æˆåŠŸæ”¶å‰² {len(clean_proxies)} ä¸ªèŠ‚ç‚¹ï¼Œå·²å­˜å…¥ mfuu.yml')
                  
              except Exception as e:
                  print(f'âŒ æš´åŠ›æ¸…æ´—å¤±è´¥: {e}')
                  sys.exit(1)

          if __name__ == '__main__':
              clean_mfuu()
          "

      - name: ğŸ“¤ æ¨é€æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add mfuu.yml
          git commit -m "Update mfuu.yml (Sanitized)" || exit 0
          git push
