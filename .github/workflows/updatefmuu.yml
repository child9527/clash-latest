name: ğŸ§¼ æ¸…æ´— mfuu æ··ä¹±è®¢é˜…

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  clean-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ å®‰è£… Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install requests PyYAML

      - name: ğŸ› ï¸ è¿è¡Œæ¸…æ´—ç¨‹åº
        run: |
          cat << 'EOF' > cleaner.py
          import requests
          import yaml
          import re
          import os
          import sys

          def clean_mfuu():
              url = 'https://github.com/mfuu/v2ray/raw/refs/heads/master/clash.yaml'
              headers = {'User-Agent': 'ClashMeta'}
              try:
                  print('æ­£åœ¨ä¸‹è½½ mfuu æºå¹¶è¿›è¡Œæ·±åº¦ç±»å‹ä¿®å¤...')
                  r = requests.get(url, headers=headers, timeout=30)
                  r.raise_for_status()
                  text = r.text
                  
                  data = {'proxies': []}
                  # æå–æ¯ä¸€ä¸ªä»£ç†å— {}
                  proxy_lines = re.findall(r'-\s*\{([^}]+)\}', text)
                  
                  for line in proxy_lines:
                      p = {}
                      # å…³é”®å­—æ®µæå–
                      keys = ['name', 'server', 'port', 'type', 'cipher', 'password', 'uuid', 'alterId', 'network', 'ws-path', 'tls', 'sni', 'udp', 'skip-cert-verify']
                      for key in keys:
                          # ä¿®å¤äº† f-string ä¸­çš„å¤§æ‹¬å·è½¬ä¹‰é—®é¢˜
                          pattern = fr'{key}:\s*([^,"\s}}]+)'
                          match = re.search(pattern, line)
                          if match:
                              val = match.group(1).strip().strip('"').strip("'")
                              
                              # ä¸¥æ ¼ç±»å‹è½¬æ¢
                              if key in ['tls', 'udp', 'skip-cert-verify']:
                                  p[key] = (val.lower() == 'true')
                              elif key in ['port', 'alterId']:
                                  try:
                                      p[key] = int(val)
                                  except:
                                      p[key] = val
                              else:
                                  p[key] = val
                      if p:
                          data['proxies'].append(p)

                  if not data['proxies']:
                      print('é”™è¯¯ï¼šæœªèƒ½æå–åˆ°ä»»ä½•èŠ‚ç‚¹')
                      return

                  clean_proxies = []
                  for p in data['proxies']:
                      name = str(p.get('name', 'Node'))
                      # åªä¿ç•™ä¸­æ–‡å­—ç¬¦ã€å­—æ¯ã€æ•°å­—ã€æ¨ªæ ã€ç‚¹
                      name = re.sub(r'[^\w\s\-\.\u4e00-\u9fa5]', '', name)
                      p['name'] = name.strip() or f"Node-{p.get('server', '')}"
                      
                      if p.get('type') == 'ss':
                          method = p.get('cipher') or p.get('method')
                          if method == 'chacha20-poly1305':
                              p['cipher'] = 'chacha20-ietf-poly1305'
                      
                      clean_proxies.append(p)

                  output = {
                      'proxies': clean_proxies,
                      'proxy-groups': [{'name': 'Proxy', 'type': 'select', 'proxies': [p['name'] for p in clean_proxies]}],
                      'rules': ['MATCH,Proxy']
                  }

                  with open('mfuu.yml', 'w', encoding='utf-8') as f:
                      yaml.dump(output, f, allow_unicode=True, sort_keys=False, default_flow_style=False)
                  
                  print(f'âœ… ç±»å‹æ ¡å‡†æˆåŠŸï¼å…±è®¡ {len(clean_proxies)} ä¸ªèŠ‚ç‚¹å·²å­˜å…¥ mfuu.yml')
                  
              except Exception as e:
                  print(f'âŒ æ·±åº¦ä¿®å¤å¤±è´¥: {e}')
                  sys.exit(1)

          if __name__ == '__main__':
              clean_mfuu()
          EOF
          python cleaner.py

      - name: ğŸ“¤ æ¨é€æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add mfuu.yml
          git commit -m "Fix mfuu regex and types" || exit 0
          git push
