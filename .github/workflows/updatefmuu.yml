name: ğŸ§¼ æ¸…æ´— mfuu æ··ä¹±è®¢é˜…

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹è¿è¡Œ

jobs:
  clean-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ å®‰è£… Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ› ï¸ è¿è¡Œæ¸…æ´—ç¨‹åº
        run: |
          python -c "
          import requests
          import yaml
          import re
          import os

          def clean_mfuu():
              url = 'https://github.com/mfuu/v2ray/raw/refs/heads/master/clash.yaml'
              headers = {'User-Agent': 'ClashMeta'}
              try:
                  print('æ­£åœ¨ä¸‹è½½ mfuu æº...')
                  r = requests.get(url, headers=headers, timeout=30)
                  r.raise_for_status()
                  
                  content = r.text
                  # ä¿®å¤åµŒå¥—åŒå¼•å·
                  content = re.sub(r'\"([^\"]*)\"([^\"]*)\"([^\"]*)', r'\1\2\3', content)
                  
                  data = yaml.safe_load(content)
                  if not data or 'proxies' not in data:
                      print('æ•°æ®æ ¼å¼é”™è¯¯')
                      return

                  clean_proxies = []
                  for p in data['proxies']:
                      if not isinstance(p, dict): continue
                      
                      # ä½¿ç”¨æ›´å®‰å…¨çš„å­—ç¬¦æ¸…ç†æ–¹å¼ï¼Œé¿å¼€å•åŒå¼•å·å†²çª
                      raw_name = str(p.get('name', 'Unknown'))
                      # è¿™é‡ŒæŠŠå•åŒå¼•å·éƒ½å¹²æ‰
                      for char in ['\"', \"'\"]:
                          raw_name = raw_name.replace(char, '')
                      p['name'] = raw_name.strip()
                      
                      if p.get('type') == 'ss' and p.get('cipher') == 'chacha20-poly1305':
                          p['cipher'] = 'chacha20-ietf-poly1305'
                      
                      clean_proxies.append(p)

                  output = {
                      'proxies': clean_proxies,
                      'proxy-groups': [
                          {
                              'name': 'Proxy',
                              'type': 'select',
                              'proxies': [p['name'] for p in clean_proxies]
                          }
                      ],
                      'rules': ['MATCH,Proxy']
                  }

                  with open('mfuu.yml', 'w', encoding='utf-8') as f:
                      yaml.dump(output, f, allow_unicode=True, sort_keys=False, default_flow_style=False)
                  print(f'âœ… æˆåŠŸæ¸…æ´—å¹¶ä¿å­˜ {len(clean_proxies)} ä¸ªèŠ‚ç‚¹')
                  
              except Exception as e:
                  print(f'âŒ è¿è¡Œå‡ºé”™: {e}')
                  import sys
                  sys.exit(1)

          if __name__ == '__main__':
              clean_mfuu()
          "

      - name: ğŸ“¤ æ¨é€æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add mfuu.yml
          git commit -m "Update mfuu.yml (Cleaned)" || exit 0
          git push
