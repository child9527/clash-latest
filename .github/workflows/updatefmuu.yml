name: ğŸ§¼ æ¸…æ´— mfuu æ··ä¹±è®¢é˜…

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  clean-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ å®‰è£… Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install requests PyYAML

      - name: ğŸ› ï¸ è¿è¡Œæ¸…æ´—ç¨‹åº
        run: |
          cat << 'EOF' > cleaner.py
          import requests
          import yaml
          import re
          import os
          import sys

          def clean_mfuu():
              url = 'https://github.com/mfuu/v2ray/raw/refs/heads/master/clash.yaml'
              headers = {'User-Agent': 'ClashMeta'}
              try:
                  print('æ­£åœ¨ä¸‹è½½ mfuu æºå¹¶è¿›è¡Œå…¨å­—æ®µå…¼å®¹æ€§æ¸…æ´—...')
                  r = requests.get(url, headers=headers, timeout=30)
                  r.raise_for_status()
                  text = r.text
                  
                  data = {'proxies': []}
                  # æå–æ¯ä¸€ä¸ªä»£ç†å— {}
                  proxy_lines = re.findall(r'-\s*\{([^}]+)\}', text)
                  
                  for line in proxy_lines:
                      p = {}
                      # æ‰©å±•æå–å­—æ®µï¼šå¢åŠ  plugin, obfs ç›¸å…³å†…å®¹
                      keys = ['name', 'server', 'port', 'type', 'cipher', 'password', 'uuid', 'alterId', 
                              'network', 'ws-path', 'tls', 'sni', 'udp', 'plugin', 'obfs', 'obfs-host']
                      
                      for key in keys:
                          pattern = fr'{key}:\s*([^,"\s}}]+)'
                          match = re.search(pattern, line)
                          if match:
                              val = match.group(1).strip().strip('"').strip("'")
                              # ç±»å‹è½¬æ¢
                              if key in ['tls', 'udp']:
                                  p[key] = (val.lower() == 'true')
                              elif key in ['port', 'alterId']:
                                  try: p[key] = int(val)
                                  except: p[key] = val
                              else:
                                  p[key] = val
                      
                      if not p: continue

                      # --- ç‰¹æ®Šé€»è¾‘ï¼šä¿®å¤ obfs ç¼ºå¤±é”™è¯¯ ---
                      if p.get('plugin') == 'obfs':
                          # æ„é€  Clash è¦æ±‚çš„ plugin-opts ç»“æ„
                          host = p.get('obfs-host', 'www.bing.com')
                          mode = p.get('obfs', 'http') # é»˜è®¤è¡¥å…¨ä¸º http
                          p['plugin-opts'] = {'mode': mode, 'host': host}
                          # æ¸…ç†æ‰ä¸´æ—¶å­—æ®µé˜²æ­¢å¹²æ‰°
                          if 'obfs' in p: del p['obfs']
                          if 'obfs-host' in p: del p['obfs-host']

                      data['proxies'].append(p)

                  clean_proxies = []
                  for p in data['proxies']:
                      # 1. åå­—è„±æ•
                      name = str(p.get('name', 'Node'))
                      name = re.sub(r'[^\w\s\-\.\u4e00-\u9fa5]', '', name)
                      p['name'] = name.strip() or f"Node-{p.get('server', '')}"
                      
                      # 2. SS åè®®æ ¡å‡†
                      if p.get('type') == 'ss':
                          method = p.get('cipher') or p.get('method', '')
                          if 'chacha20-poly1305' in method:
                              p['cipher'] = 'chacha20-ietf-poly1305'
                      
                      clean_proxies.append(p)

                  output = {
                      'proxies': clean_proxies,
                      'proxy-groups': [{'name': 'Proxy', 'type': 'select', 'proxies': [p['name'] for p in clean_proxies]}],
                      'rules': ['MATCH,Proxy']
                  }

                  with open('mfuu.yml', 'w', encoding='utf-8') as f:
                      yaml.dump(output, f, allow_unicode=True, sort_keys=False, default_flow_style=False)
                  
                  print(f'âœ… å…¨å…¼å®¹ä¿®å¤å®Œæˆï¼å…±è®¡ {len(clean_proxies)} ä¸ªèŠ‚ç‚¹ã€‚')
                  
              except Exception as e:
                  print(f'âŒ ç»ˆææ¸…æ´—å¤±è´¥: {e}')
                  sys.exit(1)

          if __name__ == '__main__':
              clean_mfuu()
          EOF
          python cleaner.py

      - name: ğŸ“¤ æ¨é€æ›´æ–°åˆ°ä»“åº“
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add mfuu.yml
          git commit -m "Fix: plugin obfs configuration error" || exit 0
          git push
