name: Update Clash Latest (Aggregated)

on:
  schedule:
    # 北京时间 08, 12, 16, 20 点各执行一次
    - cron: "0 0,4,8,12 * * *"
  workflow_dispatch: # 支持手动点击运行

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check if already updated today
        id: check_status
        run: |
          BEIJING_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          LAST_COMMIT_DATE=$(git log -1 --format=%s | grep -oP '\d{8}' || echo "none")
          
          # 如果是手动触发，或者今天还没更新过，则执行更新
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] || [ "$LAST_COMMIT_DATE" != "$BEIJING_DATE" ]; then
            echo "should_update=true" >> $GITHUB_ENV
          else
            echo "should_update=false" >> $GITHUB_ENV
          fi

      - name: Download and Merge Clash files
        if: env.should_update == 'true'
        run: |
          echo "proxies:" > latest.yml
          
          # 下载源1
          curl -fSL "https://raw.githubusercontent.com/Pawdroid/Free-servers/main/sub" -o s1.yml || echo "S1 failed"
          # 下载源2
          curl -fSL "https://raw.githubusercontent.com/free-nodes/clashfree/main/clash.yml" -o s2.yml || echo "S2 failed"
          # 下载源3
          curl -fSL "https://raw.githubusercontent.com/ermaozi01/free_clash_vpn/main/subscribe/clash.yml" -o s3.yml || echo "S3 failed"

          # 提取节点逻辑：寻找以 "  - name:" 开头的行直到文件结尾，并过滤掉重复的 "proxies:" 标签
          for f in s1.yml s2.yml s3.yml; do
            if [ -f "$f" ]; then
              # 提取节点列表并追加到 latest.yml
              sed -n '/^proxies:/,$p' "$f" | grep -v "^proxies:" >> latest.yml || true
            fi
          done

          # 清理
          rm -f s1.yml s2.yml s3.yml

      - name: Commit and push
        if: env.should_update == 'true'
        run: |
          DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add latest.yml
          
          # 检查是否有文件变化，防止空提交报错
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update Aggregated latest.yml (Date: $DATE)"
            git push
          fi
