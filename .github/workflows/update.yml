name: Update Clash Latest (Aggregated)

on:
  schedule:
    # 北京时间 08, 12, 16, 20 点各执行一次
    - cron: "0 0,4,8,12 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check if already updated today
        id: check_status
        run: |
          BEIJING_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          LAST_COMMIT_DATE=$(git log -1 --format=%s | grep -oP '\d{8}' || echo "none")
          if [ "$LAST_COMMIT_DATE" == "$BEIJING_DATE" ]; then
            echo "skip_update=true" >> $GITHUB_ENV
          else
            echo "skip_update=false" >> $GITHUB_ENV
          fi

      - name: Download Aggregated Clash file
        if: env.skip_update == 'false'
        run: |
          # 聚合了三个源：Pawdroid, free-nodes, ermaozi01
          # 使用了公共转换后端 api-suc.0z.gs
          # 开启了自动测速排序(sort=true)和UDP支持(udp=true)
          URL="https://api-suc.0z.gs/sub?target=clash&url=https://proxy.v2gh.com/https://raw.githubusercontent.com/Pawdroid/Free-servers/main/sub|https://proxy.v2gh.com/https://raw.githubusercontent.com/free-nodes/clashfree/refs/heads/main/clash.yml|https://raw.githubusercontent.com/ermaozi01/free_clash_vpn/main/subscribe/clash.yml&insert=false&emoji=true&list=false&tfo=false&scv=true&fdn=false&sort=true&udp=true&new_name=true"
          
          if curl -fSL "$URL" -o latest.yml; then
            echo "download_success=true" >> $GITHUB_ENV
          else
            echo "Download failed. Check backend API status."
            echo "download_success=false" >> $GITHUB_ENV
          fi

      - name: Commit and push
        if: env.skip_update == 'false' && env.download_success == 'true'
        run: |
          DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add latest.yml
          git commit -m "Update Aggregated latest.yml (Date: $DATE)" || exit 0
          git push
