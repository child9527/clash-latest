name: Update Clash Latest (Aggregated)

on:
  schedule:
    - cron: "0 0,4,8,12 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Check if already updated today
        id: check_status
        run: |
          BEIJING_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          LAST_COMMIT_DATE=$(git log -1 --format=%s | grep -oP '\d{8}' || echo "none")
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] || [ "$LAST_COMMIT_DATE" != "$BEIJING_DATE" ]; then
            echo "should_update=true" >> $GITHUB_ENV
          else
            echo "should_update=false" >> $GITHUB_ENV
          fi

      - name: Download and Clean Proxies
        if: env.should_update == 'true'
        run: |
          echo "proxies:" > latest.yml
          
          # 下载三个源，去掉 -f 选项防止 curl 因为 404 直接报错退出，改用判断逻辑
          curl -sL "https://raw.githubusercontent.com/Pawdroid/Free-servers/main/sub" -o s1.yml || touch s1.yml
          # 修正后的源2链接（移除了 refs/heads/）
          curl -sL "https://raw.githubusercontent.com/free-nodes/clashfree/main/clash.yml" -o s2.yml || touch s2.yml
          curl -sL "https://raw.githubusercontent.com/ermaozi01/free_clash_vpn/main/subscribe/clash.yml" -o s3.yml || touch s3.yml

          # 处理逻辑
          for f in s1.yml s2.yml s3.yml; do
            # 检查文件是否存在且不是 404 错误页面（404 页面通常很小且包含 "404" 字样）
            if [ -s "$f" ] && ! grep -q "404: Not Found" "$f"; then
              sed -n '/- name:/,$p' "$f" | awk '
                BEGIN {ORS="\n"}
                /^- name:/ {show=1} 
                /^[^ ]/ && !/^- name:/ {show=0} 
                /type: (select|url-test|fallback|load-balance)/ {show=0}
                {if(show) print "  " $0}
              ' | sed 's/^    -/  -/g' >> temp_nodes.yml || true
            fi
          done

          # 最后的清洗：确保格式整齐，只保留真正的节点部分
          if [ -f temp_nodes.yml ]; then
            grep "  - name:" -A 15 temp_nodes.yml | grep -v "^\-\-" | grep -v "proxies:" >> latest.yml
          fi

          rm -f s1.yml s2.yml s3.yml temp_nodes.yml

      - name: Commit and push
        if: env.should_update == 'true'
        run: |
          DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add latest.yml
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Update Aggregated latest.yml (Date: $DATE)"
            git push
          fi
