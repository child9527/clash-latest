name: Update Free Nodes (Mirror)

on:
  schedule:
    - cron: "17 0,4,8,12 * * *"
  workflow_dispatch:

jobs:
  update:
    name: åŒæ­¥ FreeNodes é•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: æ£€æŸ¥ä»Šæ—¥æ›´æ–°çŠ¶æ€
        id: check_status
        run: |
          BEIJING_DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          LAST_COMMIT_MSG=$(git log -1 --format=%s || echo "åˆå§‹æäº¤")
          
          echo "ğŸ“… å½“å‰åŒ—äº¬æ—¥æœŸ: $BEIJING_DATE"
          echo "ğŸ“ æœ€åæäº¤è®°å½•: $LAST_COMMIT_MSG"
          
          if [[ "$LAST_COMMIT_MSG" == *"$BEIJING_DATE"* ]] && [[ "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "âœ… ä»Šæ—¥æ•°æ®å·²åŒæ­¥ï¼Œè·³è¿‡æ‰§è¡Œã€‚"
            echo "should_update=false" >> $GITHUB_ENV
          else
            echo "ğŸš€ éœ€è¦æ›´æ–°æ•°æ®ã€‚"
            echo "should_update=true" >> $GITHUB_ENV
          fi

      - name: ä¸‹è½½å¹¶å¤„ç†åŒæ­¥
        if: env.should_update == 'true'
        run: |
          FOUND=false
          # å¾ªç¯å°è¯•æœ€è¿‘ 3 å¤©
          for i in {0..2}; do
            TARGET_DATE=$(TZ='Asia/Shanghai' date -d "$i days ago" +'%Y%m%d')
            # ä½¿ç”¨æ­£ç¡®çš„ master åˆ†æ”¯è·¯å¾„
            URL="https://raw.githubusercontent.com/free-nodes/clashfree/refs/heads/master/clash${TARGET_DATE}.yml"
            echo "ğŸ” æ­£åœ¨å°è¯•ä» master åˆ†æ”¯æŠ“å–: $TARGET_DATE"
            
            if curl -sLf "$URL" -o temp.yml && [ -s temp.yml ]; then
              echo "âœ… æˆåŠŸæ‰¾åˆ°å¯ç”¨æº: $TARGET_DATE"
              mv temp.yml free-nodes.yml
              echo "final_msg=è‡ªåŠ¨åŒæ­¥ï¼šFreeNodes-$TARGET_DATE" >> $GITHUB_ENV
              FOUND=true
              break
            fi
            echo "âŒ $TARGET_DATE æ–‡ä»¶ä¸å­˜åœ¨æˆ–å°šæœªå‘å¸ƒ"
          done

          if [ "$FOUND" = false ]; then
            echo "âš ï¸ è­¦å‘Šï¼šæœ€è¿‘ 3 å¤©çš„è¿œç¨‹æºå‡ä¸å¯ç”¨ã€‚"
            if [ -f free-nodes.yml ]; then
              echo "ğŸ“¦ ä¿ç•™ç°æœ‰çš„æœ¬åœ°å¤‡ä»½æ–‡ä»¶ã€‚"
              echo "skip_commit=true" >> $GITHUB_ENV
            else
              echo "â— é”™è¯¯ï¼šæœ¬åœ°æ— å¤‡ä»½ä¸”è¿œç¨‹æŠ“å–å¤±è´¥ã€‚"
              exit 0
            fi
          fi

      - name: æäº¤æ›´æ–°åˆ°ä»“åº“
        if: env.should_update == 'true' && env.skip_commit != 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add free-nodes.yml
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "${{ env.final_msg }}"
            git push
            echo "âœ¨ ä»“åº“å·²æ›´æ–°å®Œæ¯•ã€‚"
          fi
